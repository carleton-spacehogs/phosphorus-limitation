---
title: "run_MaAsLin2"
author: "Jimmy Zhong"
date: "6/29/2022"
output: html_document
---

https://bioconductor.org/packages/devel/bioc/manuals/Maaslin2/man/Maaslin2.pdf
https://github.com/biobakery/Maaslin2#run-a-demo

# Install MaAsLin2 (Multivariable Associations with Linear Models)
```{r, eval=FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("Maaslin2")
```

### Run a Demo
```{r, eval=FALSE}
library(Maaslin2)
input_data <- system.file(
    'extdata','HMP2_taxonomy.tsv', package="Maaslin2")
input_metadata <-system.file(
    'extdata','HMP2_metadata.tsv', package="Maaslin2")
fit_data <- Maaslin2(
    input_data, input_metadata, 'demo_output', transform = "AST",
    fixed_effects = c('diagnosis', 'dysbiosisnonIBD','dysbiosisUC','dysbiosisCD', 'antibiotics', 'age'),
    random_effects = c('site', 'subject'),
    normalization = 'NONE',
    reference = 'diagnosis,nonIBD',
    standardize = FALSE)
```


## Jimmy's ibaray set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# setting the working directory to the location of this file
setwd(dirname(rstudioapi::getActiveDocumentContext()$path ))
source(".init_MaAsLin.R")
```


## Retrieve metadata and the abundance of pathways per sample

I use functions from *.init_MaAsLin.R* to hide away the messy code details.

Feel free to add your own functions!!!

The g(a, b, c) %=% function() format is convenient for returning multiple
variables from a function.

*fudge_factor* is half of the lowest non-zero value in a data table.
Sometimes we want to log-transform our data, but often there are 0 in our
table, and we cannot take the log of 0. So we add a small fudge factor to
make the math works out.

```{r message=FALSE}
BGS_md = init_BGS_metadata(only_phosphate = TRUE) # BGS: Bio-GO-SHIP
g(nga, fudge_factor) %=% get_geneabundance(BGS_md) #nga: nutrient gene abundance
```

# run MaAsLin2
```{r}
result_dirtory = 'MaAsLin_out/nutrient_gene_Ustick2021'

BGS_md$Month = as.factor(BGS_md$Month)

fit_data <- Maaslin2(
    nga, BGS_md, result_dirtory, transform = "LOG",
    fixed_effects = c('log_phosphate','temperature',
                      'Month','time_in_day','geo_loc_name'),
    reference = 'time_in_day,8to12;geo_loc_name,Pacific Ocean',
    normalization = 'NONE',
    standardize = FALSE)
```

# Bray-Curtis PCoA with vegan

PCoA stands for Principal Coordinate Analysis

Use sqrt instead of log to transform, because PCoA does not take
in negative values in the matrix (computing a negative distance does
not make sense).

```{r}
library(vegan)
# get_significant_res(): Jimmy's function in .init_MaAsLin.R.
# strict: set significant level
all_sign_genes <- get_significant_res(result_dirtory, "Month", strict = 0.05) 
PCoA_df <- nga[all_sign_genes]

# https://ordnews.colostate.narkive.com/lMWF502c/1593-log-sqrt-and-other-transformation-with-bray-curtis-dissimilarity
#load dataset
data.bray = vegdist(sqrt(PCoA_df))
#build coordinates
data.b.pcoa = cmdscale(data.bray, k = (nrow(PCoA_df) - 1), eig = TRUE)
#summary
str(data.b.pcoa)
#build df from first two coordinates
pcoa = data.frame(PC1 = data.b.pcoa$points[,1], PC2 = data.b.pcoa$points[,2])

pcoa = merge(pcoa, BGS_md, by =0) #work-in metadata

#viz
ggplot(pcoa, aes(x = PC1, y = PC2, color = Month)) + 
  geom_point(size=1.8)
ggsave("./manual_analysis_graphs/PCoA_log_month.png", 
       plot = last_plot(),
       width = 9,
       height = 6)
```


## heatmap!

Focusing on the concentration of phosphorus in the environment.
Try to find out which gene is enriched in phosphorus-poor samples.

I used some functions in *.init_MaAsLin.R* to make this process simpler

```{r}
library(pheatmap)

plot(log_phosphate~temperature, BGS_md)
summary(lm(log_phosphate~temperature, BGS_md))

md_to_graph = BGS_md[c("log_phosphate","temperature")]
md_to_graph = md_to_graph[order(md_to_graph$log_phosphate, md_to_graph$temperature),]
nga_g = gen_df_for_graphing(nga, result_dirtory, "log_phosphate")

sign_genes <- get_significant_res(result_dirtory, "log_phosphate", strict = 0.05) 
heatmap_df <- as.data.frame(t(nga[sign_genes]))

pheatmap(mat = (heatmap_df[rownames(md_to_graph)])^(1/6),
           annotation_col = md_to_graph,
           cluster_cols = F,
           cluster_rows = F,
           show_rownames = T,
           show_colnames = F,
           scale = "none")

setdiff(rownames(md_to_graph), colnames(heatmap_df))

```

## heatmap focusing on significant pathway by RYGB
```{r}
library(pheatmap)
md_to_graph = md_to_graph[order(md_to_graph$RYGB, md_to_graph$Hypoglycemia, md_to_graph$BMI),]
ppaG = gen_df_for_graphing(ppaN, res_path, "RYGB")
gen_heatmap(log10(ppaG), md_to_graph, 
            "./analysis_graph/pathway_heatmap/MaAsLin_sig_RYGB_log10.png")

# Smaller heatmap, only select those with normalized p.val, or BH, < 0.05
extra_sig_path = read_delim(delim = "\t",
                            file = paste(res_path, "extra_significant_results_RYGB.tsv", sep="/"))
extra_sig_ppaG = simplify_abundance_df(ppaN)[extra_sig_path$feature, ]
gen_heatmap(log10(extra_sig_ppaG), md_to_graph, 
            "./analysis_graph/pathway_heatmap/MaAsLin_sig_BH_lessthan005_RYGB_log10.png")
```

## heatmap focusing on significant pathway by cholecystectomy (gallbladder removal)
```{r}
md_to_graph = md_patti[c("Cholecystectomy","RYGB")]
md_to_graph = md_to_graph[order(md_to_graph$Cholecystectomy, md_to_graph$RYGB),]
ppaG = gen_df_for_graphing(ppaN, res_path, "Cholecystectomy")
gen_heatmap(log10(ppaG), md_to_graph,
            "./analysis_graph/pathway_heatmap/MaAsLin_sig_Cholecystectomy_log10.png")
```



